# Version 0.2.x - GitHub Repository Dropdown Selector

**Release Date**: October 22-23, 2025
**Feature**: GitHub Repository Dropdown Selector with Organization Support
**Branch**: `feature/github-repo-dropdown`

## Overview

This release introduces a dropdown-based repository selection interface with organization support, replacing the previous manual text input method for connecting GitHub repositories to projects. Users can now select from their personal and organization repositories through an intuitive two-tier dropdown system.

**v0.2.0**: Initial dropdown implementation (personal repos only)
**v0.2.1**: Added organization support with account selector
**v0.2.2**: Fixed OAuth scope to enable organization detection

## Motivation

The previous implementation required users to manually type repository names in the format `username/repository`, which was error-prone and inconvenient. This feature improves user experience by:

- **Eliminating manual typing**: Users select from a list instead of typing
- **Reducing errors**: No more typos or format mistakes
- **Better discoverability**: Users can see all their available repositories (personal + organization)
- **Faster workflow**: One click to select instead of typing full repository names
- **Organization support**: Access to organization repositories, matching industry standards (Vercel, Netlify)

## Changes Made

### New Files

#### 1. API Endpoint - Repository List with Organizations
**File**: `fullstack-agent/app/api/github/repositories/route.ts` (~100 lines)

- **Purpose**: Fetch authenticated user's GitHub repositories and organizations
- **Method**: GET
- **Authentication**: Required (session-based)
- **Functionality**:
  - Retrieves user's GitHub token from database
  - Calls GitHub API using Octokit client in parallel:
    - User information (`/user`)
    - Organizations list (`/user/orgs`)
    - All repositories (`/user/repos` with `affiliation=owner,organization_member`)
  - Builds accounts array (personal account + organizations)
  - Returns formatted list with repository metadata including owner information
- **Response Structure**:
  ```json
  {
    "accounts": [
      { "login": "username", "type": "User", "avatarUrl": "...", "name": "..." },
      { "login": "org-name", "type": "Organization", "avatarUrl": "...", "name": "..." }
    ],
    "repositories": [
      { "name": "repo", "fullName": "owner/repo", "private": false,
        "description": "...", "owner": { "login": "owner", "type": "User" } }
    ],
    "count": 48
  }
  ```
- **Error Handling**:
  - No GitHub token: 400 Bad Request
  - Invalid/expired token: 401 Unauthorized
  - Rate limiting: 429 Too Many Requests
  - General errors: 500 Internal Server Error

#### 2. Client Component - Repository Selector with Account Switching
**File**: `fullstack-agent/components/github-repository-selector.tsx` (~320 lines)

- **Type**: Client Component (React)
- **UI Library**: Shadcn/ui Select component
- **Key Features**:
  - **Two-tier dropdown system**: Account selector → Repository selector
  - Fetches accounts and repositories on mount
  - Filters repositories by selected account (personal or organization)
  - Auto-selects personal account by default
  - Loading state with spinner
  - Error state with descriptive messages
  - Empty state when no repositories found
  - Connected state showing current repository
  - Disconnect functionality
  - Toast notifications for user feedback
- **State Management**:
  - Local state for accounts, repositories, selectedAccount, loading, error
  - Computed filteredRepositories using useMemo (filters by account)
  - Separate state for connection/disconnection operations
  - Optimistic UI updates

### Modified Files

#### 1. GitHub Service (v0.2.1)
**File**: `fullstack-agent/lib/github.ts`

**Changes**:
- Added `listOrganizations()` method to fetch user's organizations
- Enhanced `listRepos()` with explicit `affiliation` parameter
- Parallel API calls for better performance

#### 2. API Endpoint (v0.2.1)
**File**: `fullstack-agent/app/api/github/repositories/route.ts`

**Changes**:
- Fetch organizations in parallel with user and repos
- Build accounts array (personal + organizations)
- Remove owner filtering (now returns all accessible repos)
- Add owner information to repository response
- Return accounts array in response

#### 3. Repository Selector Component (v0.2.1)
**File**: `fullstack-agent/components/github-repository-selector.tsx`

**Changes**:
- Add Account interface and update Repository interface
- Add account state management with selectedAccount
- Add useMemo for filtering repositories by account
- Add account selector dropdown UI
- Update fetch logic to handle accounts
- Default to personal account on mount
- Enhanced empty states for no repos in selected account

#### 4. GitHub Page (v0.2.0)
**File**: `fullstack-agent/app/projects/[id]/github/page.tsx`

**Changes**:
- Removed manual text input UI (lines 117-170)
- Removed "Create New Repository" and "Connect Existing Repository" buttons
- Replaced with `<GitHubRepositorySelector>` component
- Simplified imports (removed unused icons: Check, X, Plus, ExternalLink)
- Reduced code from ~217 lines to ~98 lines (-119 lines)

#### 5. Package Version
**File**: `fullstack-agent/package.json`

**Changes**:
- Updated version from `0.1.0` to `0.2.0` (initial dropdown)
- Updated version from `0.2.0` to `0.2.1` (organization support)

#### 6. OAuth Configuration (v0.2.2)
**File**: `fullstack-agent/lib/auth.ts` (1 line changed)

- **Purpose**: Fix GitHub OAuth scope to enable organization detection
- **Problem**: Previous scope `'read:user user:email repo'` didn't include `read:org`
- **Impact**: Organizations API returned empty array, making users appear to have no organizations
- **Solution**: Added `read:org` scope: `'read:user user:email repo read:org'`
- **Technical Details**:
  - GitHub API endpoint `GET /user/orgs` requires either `user` or `read:org` scope
  - Without proper scope, API returns 200 OK with empty array `[]`
  - This explains why Vercel (which requests `read:org`) could see organizations while our app couldn't
- **User Impact**:
  - Users must re-authenticate with GitHub to get new token with `read:org` scope
  - After re-authentication, organizations appear correctly in account dropdown
  - Resolves issue where organization repositories showed but organization accounts didn't

## Technical Details

### Data Flow (v0.2.1 with Organizations)

```
┌─────────────┐
│    User     │
└──────┬──────┘
       │ 1. Navigate to GitHub page
       ▼
┌─────────────────────────────────────┐
│  Server Component (Page)            │
│  - Fetch project from DB            │
│  - Pass currentRepo prop            │
└──────────┬──────────────────────────┘
           │ 2. Render with data
           ▼
┌─────────────────────────────────────┐
│  Client Component (Selector)        │
│  - useEffect() on mount             │
└──────────┬──────────────────────────┘
           │ 3. GET /api/github/repositories
           ▼
┌─────────────────────────────────────┐
│  API Route (Parallel Fetch)         │
│  - Verify auth                      │
│  - Get GitHub token                 │
│  - Call GitHub API (parallel):      │
│    • GET /user (user info)          │
│    • GET /user/orgs (organizations) │
│    • GET /user/repos (all repos)    │
│  - Build accounts array             │
│  - Format repos with owner info     │
└──────────┬──────────────────────────┘
           │ 4. Return accounts + repos
           ▼
┌─────────────────────────────────────┐
│  Client Component (Selector)        │
│  - Store accounts & repositories    │
│  - Auto-select personal account     │
│  - Display account selector         │
│  - Display filtered repo dropdown   │
└──────────┬──────────────────────────┘
           │ 5. User switches account
           ▼
┌─────────────────────────────────────┐
│  Client Component (Selector)        │
│  - Filter repos by selectedAccount  │
│  - Update repository dropdown       │
│  - User selects repo                │
└──────────┬──────────────────────────┘
           │ 6. POST /api/projects/{id}/github
           ▼
┌─────────────────────────────────────┐
│  API Route                          │
│  - Update project.githubRepo        │
│  - Return updated data              │
└──────────┬──────────────────────────┘
           │ 7. Success response
           ▼
┌─────────────────────────────────────┐
│  Client Component (Selector)        │
│  - Update local state               │
│  - Show success toast               │
│  - Display connected state          │
└─────────────────────────────────────┘
```

### Database Changes

**No schema changes required**. Uses existing `Project.githubRepo` field.

### API Integration

**GitHub API**: Uses `@octokit/rest` to interact with GitHub API
- Endpoints (v0.2.1):
  - `GET /user` - Fetch authenticated user information
  - `GET /user/orgs` - Fetch user's organizations
  - `GET /user/repos?affiliation=owner,organization_member` - Fetch all accessible repos
- Scope required: `read:user user:email repo read:org` (updated in v0.2.2)
- Rate limit: 5000 requests/hour for authenticated users
- API calls made in parallel for performance

### UI/UX Improvements

**v0.2.0**:
1. **Loading State**: Shows spinner with "Loading repositories..." message
2. **Error State**: Displays error messages for missing GitHub token, network failures, API errors
3. **Empty State**: Shows message when user has no repositories
4. **Connected State**: Green checkmark, repository link, disconnect button
5. **Not Connected State**: Dropdown selector, repository count display

**v0.2.1 Additions**:
6. **Account Selector**: Two-tier dropdown system (account first, then repository)
7. **Account Display**: Shows account type indicator "(Org)" for organizations
8. **Filtered View**: Repository list dynamically filters by selected account
9. **Account Count**: Displays number of available accounts (personal + organizations)
10. **Default Selection**: Auto-selects personal account on mount
11. **Empty State Enhancement**: Shows "No repositories found in [account]" when org has no repos
12. **Backward Compatible**: Users with no organizations see identical UI to v0.2.0

## Breaking Changes

None. This is a backward-compatible UI enhancement.

## Migration Guide

No migration required. The feature automatically works for all users authenticated with GitHub.
- Users with organizations will see the new account selector
- Users without organizations will see only their personal account (same as v0.2.0)

## Future Improvements

Potential enhancements discussed:
1. Add `router.refresh()` to sync server component after mutations
2. Search/filter functionality for users with many repositories or organizations
3. Display repository metadata (private/public, description, stars)
4. Repository creation flow for selected account
5. Branch selection interface
6. Webhook integration for automated deployments
7. Organization avatar images in account dropdown

## Testing Notes

**v0.2.0**:
- Manual testing completed via Chrome DevTools MCP
- Verified dropdown loading (48 repositories)
- Tested repository connection flow
- Tested disconnection flow
- Verified toast notifications
- Confirmed no console errors
- All API requests returned 200 status codes

**v0.2.1**:
- Manual testing completed via Chrome DevTools MCP
- Verified account selector displays correctly (1 account for user with no orgs)
- Tested account dropdown functionality
- Verified repository filtering by selected account
- Tested repository connection from personal account
- Verified default account selection (personal account)
- Tested backward compatibility (users with no organizations)
- Confirmed no console errors
- All API requests returned 200 status codes (3 parallel API calls)
- Performance: API response in ~3.4 seconds (acceptable)

**v0.2.2**:
- Root cause analysis revealed missing `read:org` OAuth scope
- Identified that organizations API returns empty array without proper scope
- Updated OAuth configuration in `lib/auth.ts`
- **Issue**: Organizations not detected despite Vercel showing them correctly
- **Root Cause**: Missing `read:org` scope in GitHub OAuth configuration
- **Fix**: Added `read:org` to OAuth scope: `'read:user user:email repo read:org'`
- **Action Required**: Users must re-authenticate with GitHub to obtain new token
- **Expected Result**: Organizations will appear in account dropdown after re-authentication

## Known Issues

- ~~Organization detection not working~~ **RESOLVED in v0.2.2**
  - **Previous Issue**: Organizations not detected despite having access on GitHub
  - **Root Cause**: Missing `read:org` OAuth scope
  - **Solution**: Added `read:org` scope, users must re-authenticate
  - **Status**: ✅ Resolved

- Network error during server shutdown shows generic "Failed to fetch" toast
  - **Status**: Acceptable (dev environment issue)
  - **Impact**: Production deployments won't experience this

- User re-authentication required for organization detection
  - **Issue**: Existing users must sign out and sign back in to get new OAuth token
  - **Impact**: One-time inconvenience for existing users
  - **Mitigation**: Clear documentation and error messaging

## Contributors

- Claude AI (Implementation)
- Che Zhu (Product direction & testing)
